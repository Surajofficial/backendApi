<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>User Management</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        body {
            background-color: #f3f6fb;
        }

        .action-btn {
            cursor: pointer;
            margin-right: 12px;
            font-size: 18px;
        }

        .action-btn:hover {
            opacity: 0.6;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="index.html">User Portal</a>

            <div class="d-flex gap-3 align-items-center">
                <a href="add-user.html" class="btn btn-warning btn-sm">Add User</a>
                <a href="index.html" class="btn btn-light btn-sm">Dashboard</a>

                <span class="text-white fw-semibold" id="navUserName"></span>

                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                        Account
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><button class="dropdown-item" onclick="openEditModal()">Edit Profile</button></li>
                        <li><a class="dropdown-item text-danger" onclick="logout()">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>


    <div class="container mt-4">

        <h3>User Management</h3>
        <hr>

        <!--  SEARCH + FILTERS -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input id="searchBox" class="form-control" placeholder="Search by name or email...">
            </div>
            <div class="col-md-3">
                <select id="roleFilter" class="form-control">
                    <option value="">Filter by Role</option>
                    <option value="user">User</option>
                    <option value="manager">Manager</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-secondary w-100" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <div id="alertBox"></div>

        <!-- TABLE -->
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th width="160px">Actions</th>
                </tr>
            </thead>
            <tbody id="userRows"></tbody>
        </table>

        <!-- Pagination -->
        <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-outline-secondary btn-sm" id="prevBtn" onclick="loadUsers(currentPage - 1)">‚¨Ö
                Prev</button>
            <strong id="pageInfo"></strong>
            <button class="btn btn-outline-secondary btn-sm" id="nextBtn" onclick="loadUsers(currentPage + 1)">Next
                ‚û°</button>
        </div>
    </div>


    <!-- USER MANAGEMENT MODAL (FIXED IDs) -->
    <div class="modal fade" id="manageUserModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 id="manageModalTitle">User Details</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <div id="manageModalAlert"></div>

                    <input type="hidden" id="manageUserId">

                    <div class="mb-3">
                        <label>Name</label>
                        <input id="manageName" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label>Email</label>
                        <input id="manageEmail" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label>Role</label>
                        <select id="manageRole" class="form-control">
                            <option value="user">User</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>New Password (optional)</label>
                        <input id="managePassword" type="password" class="form-control">
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-success" id="manageSaveBtn" onclick="updateUser()">Save</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Edit Profile</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="editAlert"></div>

                    <div class="mb-3">
                        <label>Name</label>
                        <input id="editName" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label>Email</label>
                        <input id="editEmail" class="form-control" readonly>
                    </div>

                    <div class="mb-3">
                        <label>New Password (optional)</label>
                        <input id="editPassword" type="password" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label>Confirm Password</label>
                        <input id="editPasswordConfirm" type="password" class="form-control">
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-success" onclick="updateProfile()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal stays untouched -->
    <script src="js/script.js"></script>


    <script>
        let modalManage;
        document.addEventListener("DOMContentLoaded", () => {
            modalManage = new bootstrap.Modal(document.getElementById("manageUserModal"));
            loadUsers();
        });

        async function loadUsers(page = 1) {
            let url = `${API}admin/users?page=${page}`;

            if (searchBox.value.trim() || roleFilter.value)
                url = `${API}admin/users/search?q=${searchBox.value}&role=${roleFilter.value}&page=${page}`;

            const res = await axios.get(url, { headers: { Authorization: `Bearer ${token}` } });

            const pagination = res.data.meta ?? res.data;
            currentPage = pagination.current_page;
            lastPage = pagination.last_page;

            pageInfo.textContent = `Page ${currentPage} of ${lastPage}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === lastPage;

            userRows.innerHTML = res.data.data.map((u, i) => `
                <tr>
                    <td>${(currentPage - 1) * pagination.per_page + i + 1}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td><span class="badge bg-${u.role === 'admin' ? 'danger' : 'secondary'}">${u.role}</span></td>
                    <td>
                        <span class="text-info action-btn" onclick="viewUser(${u.id})">üëÅ</span>
                        <span class="text-primary action-btn" onclick="editUser(${u.id})">‚úè</span>
                        <span class="text-danger action-btn" onclick="deleteUser(${u.id})">üóë</span>
                    </td>
                </tr>`).join('');
        }

        async function viewUser(id) {
            const res = await axios.get(`${API}admin/users/${id}`, { headers: { Authorization: `Bearer ${token}` } });
            const user = res.data.data;

            manageUserId.value = user.id;
            manageName.value = user.name;
            manageEmail.value = user.email;
            manageRole.value = user.role;
            managePassword.value = "";

            manageName.readOnly = true;
            manageEmail.readOnly = true;
            manageRole.disabled = true;
            managePassword.readOnly = true;

            manageSaveBtn.style.display = "none";
            manageModalTitle.textContent = `User Details`;
            manageModalAlert.innerHTML = "";

            modalManage.show();
        }

        async function editUser(id) {
            const res = await axios.get(`${API}admin/users/${id}`, { headers: { Authorization: `Bearer ${token}` } });
            const user = res.data.data;

            manageUserId.value = user.id;
            manageName.value = user.name;
            manageEmail.value = user.email;
            manageRole.value = user.role;
            managePassword.value = "";

            manageName.readOnly = false;
            manageEmail.readOnly = false;
            manageRole.disabled = false;
            managePassword.readOnly = false;

            manageSaveBtn.style.display = "inline-block";
            manageModalTitle.textContent = `Edit User`;
            manageModalAlert.innerHTML = "";

            modalManage.show();
        }

        async function updateUser() {
            const id = manageUserId.value;
            const payload = {
                name: manageName.value,
                email: manageEmail.value,
                role: manageRole.value
            };

            if (managePassword.value.trim()) payload.password = managePassword.value.trim();

            await axios.put(`${API}admin/users/${id}`, payload, { headers: { Authorization: `Bearer ${token}` } });

            manageModalAlert.innerHTML = `<div class="alert alert-success">Updated ‚úî</div>`;
            setTimeout(() => { modalManage.hide(); loadUsers(currentPage); }, 800);
        }

        async function deleteUser(id) {
            if (!confirm("Confirm Delete? üö®")) return;
            await axios.delete(`${API}admin/users/${id}`, { headers: { Authorization: `Bearer ${token}` } });
            loadUsers(currentPage);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>